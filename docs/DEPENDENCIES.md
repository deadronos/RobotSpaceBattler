# Third-party Libraries Overview

This document is generated from package.json and installed package metadata. It lists version ranges, repository links, official docs/homepages, and short descriptions.

## Runtime dependencies

- @dimforge/rapier3d ^0.19.0 ‚Äî 3-dimensional physics engine in Rust - official JS bindings.
  - Repo: [github.com/dimforge/rapier.js](https://github.com/dimforge/rapier.js)
  - Docs: [rapier.rs/docs/user_guides/javascript](https://rapier.rs/docs/user_guides/javascript)

- @react-three/drei ^10.7.6 ‚Äî useful add-ons for react-three-fiber
  - Repo: [github.com/pmndrs/drei](https://github.com/pmndrs/drei)
  - Docs: [docs.pmnd.rs/drei](https://docs.pmnd.rs/drei)

- @react-three/fiber ^9.3.0 ‚Äî A React renderer for Threejs
  - Repo: [github.com/pmndrs/react-three-fiber](https://github.com/pmndrs/react-three-fiber)
  - Docs: [docs.pmnd.rs/react-three-fiber](https://docs.pmnd.rs/react-three-fiber)

- @react-three/postprocessing ^3.0.4 ‚Äî postprocessing wrapper for React and @react-three/fiber
  - Repo: [github.com/pmndrs/react-postprocessing](https://github.com/pmndrs/react-postprocessing)
  - Docs: [docs.pmnd.rs/react-postprocessing](https://docs.pmnd.rs/react-postprocessing)

- @react-three/rapier ^2.1.0 ‚Äî
  - Repo: [github.com/pmndrs/react-three-rapier/tree/master/packages/react-three-rapier](https://github.com/pmndrs/react-three-rapier/tree/master/packages/react-three-rapier)
  - Docs: [docs.pmnd.rs/react-three-rapier](https://docs.pmnd.rs/react-three-rapier)

- miniplex ^2.0.0 ‚Äî A developer-friendly entity management system for games and similarly demanding applications, based on ECS architecture.
  - Docs: [github.com/hmans/miniplex](https://github.com/hmans/miniplex#readme)

- react ^19.1.1 ‚Äî React is a JavaScript library for building user interfaces.
  - Repo: [github.com/facebook/react](https://github.com/facebook/react)
  - Docs: [react.dev](https://react.dev)

- react-dom ^19.1.1 ‚Äî React package for working with the DOM.
  - Repo: [github.com/facebook/react](https://github.com/facebook/react)
  - Docs: [react.dev](https://react.dev)

- three ^0.180.0 ‚Äî JavaScript 3D library
  - Repo: [github.com/mrdoob/three.js](https://github.com/mrdoob/three.js)
  - Docs: [threejs.org/docs](https://threejs.org/docs)

- zustand ^5.0.8 ‚Äî üêª Bear necessities for state management in React
  - Repo: [github.com/pmndrs/zustand](https://github.com/pmndrs/zustand)
  - Docs: [zustand.docs.pmnd.rs](https://zustand.docs.pmnd.rs)

## Dev dependencies

- @playwright/test ^1.55.0 ‚Äî A high-level API to automate web browsers
  - Repo: [github.com/microsoft/playwright](https://github.com/microsoft/playwright)
  - Docs: [playwright.dev](https://playwright.dev)

- @testing-library/jest-dom ^6.8.0 ‚Äî Custom jest matchers to test the state of the DOM
  - Repo: [github.com/testing-library/jest-dom](https://github.com/testing-library/jest-dom)
  - Docs: [testing-library.com/docs/ecosystem-jest-dom](https://testing-library.com/docs/ecosystem-jest-dom/)

- @testing-library/react ^16.3.0 ‚Äî Simple and complete React DOM testing utilities that encourage good testing practices.
  - Repo: [github.com/testing-library/react-testing-library](https://github.com/testing-library/react-testing-library)
  - Docs: [testing-library.com/docs/react-testing-library/intro](https://testing-library.com/docs/react-testing-library/intro/)

- @types/react ^19.1.13 ‚Äî TypeScript definitions for react
  - Repo: [github.com/DefinitelyTyped/DefinitelyTyped](https://github.com/DefinitelyTyped/DefinitelyTyped)
  - Docs: [github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/react](https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/react)

- @types/react-dom ^19.1.9 ‚Äî TypeScript definitions for react-dom
  - Repo: [github.com/DefinitelyTyped/DefinitelyTyped](https://github.com/DefinitelyTyped/DefinitelyTyped)
  - Docs: [github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/react-dom](https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/react-dom)

- @vitejs/plugin-react-swc ^4.0.1 ‚Äî Speed up your Vite dev server with SWC
  - Repo: [github.com/vitejs/vite-plugin-react](https://github.com/vitejs/vite-plugin-react)
  - Docs: [vite.dev/guide](https://vite.dev/guide/)

- eslint ^9.35.0 ‚Äî An AST-based pattern checker for JavaScript.
  - Docs: [eslint.org](https://eslint.org)

- eslint-config-prettier ^10.1.8 ‚Äî Turns off all rules that are unnecessary or might conflict with Prettier.
  - Docs: [github.com/prettier/eslint-config-prettier](https://github.com/prettier/eslint-config-prettier#readme)

- eslint-plugin-react ^7.37.5 ‚Äî React specific linting rules for ESLint
  - Repo: [github.com/jsx-eslint/eslint-plugin-react](https://github.com/jsx-eslint/eslint-plugin-react)
  - Docs: [github.com/jsx-eslint/eslint-plugin-react](https://github.com/jsx-eslint/eslint-plugin-react#readme)

- jsdom ^27.0.0 ‚Äî A JavaScript implementation of many web standards
  - Repo: [github.com/jsdom/jsdom](https://github.com/jsdom/jsdom)
  - Docs: [github.com/jsdom/jsdom](https://github.com/jsdom/jsdom#readme)

- playwright ^1.55.0 ‚Äî A high-level API to automate web browsers
  - Repo: [github.com/microsoft/playwright](https://github.com/microsoft/playwright)
  - Docs: [playwright.dev](https://playwright.dev)

- prettier ^3.6.2 ‚Äî Prettier is an opinionated code formatter
  - Docs: [prettier.io](https://prettier.io)

- typescript ^5.9.2 ‚Äî TypeScript is a language for application scale JavaScript development
  - Repo: [github.com/microsoft/TypeScript](https://github.com/microsoft/TypeScript)
  - Docs: [www.typescriptlang.org](https://www.typescriptlang.org)

- vite ^7.1.5 ‚Äî Native-ESM powered web dev build tool
  - Repo: [github.com/vitejs/vite](https://github.com/vitejs/vite)
  - Docs: [vite.dev](https://vite.dev)

- vitest ^3.2.4 ‚Äî Next generation testing framework powered by Vite
  - Repo: [github.com/vitest-dev/vitest](https://github.com/vitest-dev/vitest)
  - Docs: [vitest.dev](https://vitest.dev)

## Physics Loop Configuration (React-Three-Rapier)

**Decision**: Use `updateLoop="independent"` for @react-three/rapier

**Rationale**:

- Rapier runs its own physics loop independent of the render frame rate
- Ensures smooth physics simulation even when rendering is slower or on-demand
- The Simulation's fixed-step loop (via `useFixedStepLoop`) remains authoritative
  for game logic and determinism
- Physics updates are synced to ECS via `PhysicsSyncSystem` which copies RigidBody
  transforms to entity positions
- This separation allows visual coherence while maintaining deterministic gameplay
  logic

**Alternative Considered**: `updateLoop="follow"` would tie Rapier's updates directly
to render frames, but this would couple physics timing to render performance and
could introduce non-determinism.

**Verification**: Integration tests confirm that with `independent` mode:

1. Fixed-step gameplay logic remains deterministic (seeded tests produce identical
   traces)
2. Physics visuals remain smooth during variable frame rates
3. Pause/resume functionality works correctly without physics drift

**References**:

- [React Three Rapier Docs - Physics Configuration](https://docs.pmnd.rs/react-three-rapier)
- See `src/components/Scene.tsx` for implementation
- See `src/systems/PhysicsSyncSystem.ts` for ECS-physics synchronization

## StepContext harness & observability

- For deterministic tests, use `src/utils/fixedStepDriver.ts` to create a seeded `FixedStepDriver`.
  The driver exposes `stepOnce()` which returns a `StepContext` object (frameCount, simNowMs,
  rng, idFactory) that can be passed into systems for deterministic evaluation. Example:

  ```ts
  import { createFixedStepDriver } from '../src/utils/fixedStepDriver';
  const driver = createFixedStepDriver(12345, 1/60);
  const ctx = driver.stepOnce();
  mySystem(world, ctx);
  ```

- Diagnostics: The project exposes a runtime event log (bounded ring buffer) and
  fixed-step metrics. Enable `showFixedStepMetrics` in the Diagnostics overlay to surface
  steps-per-frame, backlog, last rAF timestamp, and invalidation counts. These metrics are
  useful when validating rAF-driven TickDriver behavior and physics update-loop coherence.

## Physics Adapter (Rapier integration)

- The repository exposes a small physics adapter abstraction in `src/utils/physicsAdapter.ts`.
  - `createRapierAdapter({ world, mapHitToEntityId })` wraps a Rapier-compatible world object
    (for example the Rapier world returned by `useRapier()` or the low-level Rapier instance).
  - The adapter exposes `raycast`, `overlapSphere` and `proximity` methods and will try
    common Rapier entry points (`raycast`, `castRay`, `queryPipeline.castRay`, `raw.castRay`) in
    prioritized order.
  - `mapHitToEntityId(hit)` can be provided to map Rapier collider/body objects to ECS entity
    ids. If omitted the adapter uses `extractEntityIdFromRapierHit()` heuristics.

- Tests and contract helpers also provide `createDeterministicAdapter(seed)` for deterministic
  unit tests and parity checks.

- Usage example (in application code):

```ts
import { createRapierAdapter } from '../src/utils/physicsAdapter';
import { useRapier } from '@react-three/rapier';

function usePhysicsAdapter() {
  const { world } = useRapier();
  const adapter = createRapierAdapter({ world });
  return adapter;
}
```

### Rapier collider userData conventions

When mapping Rapier collider/body objects back to ECS entities the codebase uses a small set
of conventions to simplify adapters and unit tests. The helper `extractEntityIdFromRapierHit`
implements the lookup heuristics used across systems. Important notes:

- Gameplay IDs in the simulation are canonicalized to strings. When mapping a Rapier hit to
  an ECS entity the adapter should return the entity's gameplay id as a string (`"42"`).

- Preferred Rapier payload fields the adapter will inspect (in order):
  - `collider.userData.id` ‚Äî numeric or string id set on collider's userData (adapter will stringify numeric ids)
  - `collider.entityId` ‚Äî numeric or string id set directly on the collider wrapper
  - `body.__entityId` or `collider.__entityId` ‚Äî private/internal numeric markers set by some runtimes

Adapters should prefer `mapHitToEntityId(hit)` when available and fall back to
`extractEntityIdFromRapierHit(hit)` as a heuristic. Unit tests in
`tests/contracts/rapierAdapter.contract.test.ts` assert that the adapter will correctly
read ids from these common fields and that ids are returned as strings for canonical
consumption by game systems.

